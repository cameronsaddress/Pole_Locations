INFO:__main__:Starting Fusion Service...
INFO:__main__:Executing Fusion: Updating Existing Poles with new AI sightings...
INFO:__main__:Executing Fusion: Inserting New Flagged Poles...
ERROR:__main__:Fusion failed: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "ix_poles_pole_id"
DETAIL:  Key (pole_id)=(AI_NEW_20251212_175634_2ade1e) already exists.

[SQL: 
            INSERT INTO poles (id, pole_id, location, status, last_verified_at, tags, financial_impact)
            SELECT 
                gen_random_uuid(), 
                'AI_NEW_' || to_char(now(), 'YYYYMMDD_HH24MISS') || '_' || substr(md5(random()::text), 1, 6), 
                d.location, 
                CASE 
                    WHEN d.class_name LIKE '%%damage%%' THEN 'Critical'
                    WHEN d.class_name LIKE '%%leaning%%' THEN 'Critical'
                    ELSE 'Flagged'
                END, 
                now(), 
                d.tags || jsonb_build_object('source', 'AI_Discovery', 'initial_conf', d.confidence),
                CASE 
                    WHEN d.class_name LIKE '%%damage%%' THEN %(damage_cost)s
                    WHEN d.class_name LIKE '%%leaning%%' THEN %(leaning_cost)s
                    WHEN d.class_name LIKE '%%vegetation%%' THEN %(veg_cost)s
                    ELSE 0.0
                END
            FROM detections d
            WHERE d.confidence > %(new_conf)s
            -- Ensure we ignore trash detections far from roads (Context Filter)
            AND (d.road_distance_m IS NULL OR d.road_distance_m < %(max_road_dist)s) 
            -- Crucial: Do not duplicate existing poles
            AND NOT EXISTS (
                SELECT 1 FROM poles p 
                WHERE ST_DWithin(p.location::geography, d.location::geography, 10.0::float8)
            )
            ;
            ]
[parameters: {'damage_cost': 1500.0, 'leaning_cost': 500.0, 'veg_cost': 200.0, 'new_conf': 0.2, 'max_road_dist': 150.0}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
